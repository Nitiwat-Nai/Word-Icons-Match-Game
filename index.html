<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Icons Match üß†</title> 
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL THEME SETUP --- */
        :root {
            /* Fallback Colors (L1-L4: Blue Theme) */
            --color-primary: #1976D2; /* Dark Blue */
            --color-secondary: #00BCD4; /* Cyan/Accent */
            --color-card-front: #BBDEFB; /* Light Blue */
            --color-card-back: #1976D2; 
            --color-text-light: #FFFFFF;
            
            --color-correct: #8BC34A; /* Lime Green */
            --color-wrong: #F44336; /* Red */
            --color-bg: #E3F2FD; /* Lighter Blue Background */
            --color-text-dark: #263238;
        }
        
        /* Level 5-8 Theme: Pink/Violet */
        .level-5-8-theme {
            --color-primary: #8E24AA; /* Dark Violet */
            --color-secondary: #FF4081; /* Pink/Accent */
            --color-card-front: #F8BBD0; /* Light Pink */
            --color-card-back: #8E24AA; 
            --color-bg: #FCE4EC; /* Lighter Pink Background */
        }
        
        /* Level 9-10 Theme: Yellow/Orange */
        .level-9-10-theme {
            --color-primary: #FF9800; /* Orange */
            --color-secondary: #FFEB3B; /* Yellow/Accent */
            --color-card-front: #FFE0B2; /* Light Orange */
            --color-card-back: #FF9800; 
            --color-bg: #FFF3E0; /* Lighter Orange Background */
        }
        
        /* Level 11-12 Theme: Green/Teal (New Theme) */
        .level-11-12-theme {
            --color-primary: #00796B; /* Dark Teal */
            --color-secondary: #4DB6AC; /* Light Teal/Accent */
            --color-card-front: #B2DFDB; /* Light Green-Blue */
            --color-card-back: #00796B; 
            --color-bg: #E0F2F1; /* Lighter Teal Background */
        }

        /* --- CONTAINER & BASE STYLES --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            background-color: #FFFFFF;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            transition: background-color 0.5s;
        }

        header {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            padding: 1rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.5s;
        }
        header h1 { font-size: 1.8rem; margin: 0; } 
        
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: flex-start; 
            gap: 15px;
        }
        .screen.active { display: flex; }

        .status-bar {
             display: flex;
             justify-content: space-around;
             padding: 10px 0;
             font-weight: bold;
             font-size: 1rem;
             color: var(--color-primary);
             transition: color 0.5s;
        }
        
        #level-grid-select {
             /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 12 ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
             display: grid;
             grid-template-columns: repeat(3, 1fr); 
             gap: 15px;
             padding: 0.5rem 0;
        }

        /* --- Card Grid and Card Styles --- */
        #game-grid {
            width: 95%;
            margin: 1rem auto;
            display: grid;
            gap: 10px;
        }
        
        .card {
            height: 85px; 
            perspective: 1000px; 
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
        }

        /* Card Flip Animation */
        .card.flipped .card-inner { transform: rotateY(180deg); }

        .card-inner {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            position: relative; 
        }

        /* Shake Effect for Error */
        @keyframes card-shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-2px, 0) rotate(-1deg); }
            30% { transform: translate(2px, 0) rotate(0deg); }
            50% { transform: translate(-2px, 0) rotate(1deg); }
            70% { transform: translate(2px, 0) rotate(-1deg); }
            90% { transform: translate(-2px, 0) rotate(0deg); }
        }
        .card-inner.shake-error {
            animation: card-shake 0.5s ease-in-out;
        }
        
        /* Jump Effect for Match */
        .card.matched-correct {
            animation: jump 0.8s ease-out;
        }
        @keyframes jump {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
            50% { transform: scale(1.08) translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-weight: 700;
            padding: 5px;
            box-sizing: border-box;
            text-align: center;
        }

        .card-back {
            background-color: var(--color-card-back);
            color: var(--color-text-light);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,.2) 0px, rgba(255,255,255,.2) 1px, transparent 1px, transparent 10px);
            border: 3px solid var(--color-primary);
            font-size: 1.5rem;
        }

        .card-front {
            background-color: var(--color-card-front);
            color: var(--color-text-dark);
            transform: rotateY(180deg);
            border: 3px solid var(--color-secondary);
            font-size: 1.1rem; 
        }
        
        .card-content-icon {
            font-size: 2.5rem; 
        }
        
        .card.matched .card-inner {
            box-shadow: 0 0 15px var(--color-correct);
            opacity: 0.5;
            cursor: default;
        }
        .card.matched .card-front {
             border-color: var(--color-correct);
        }

        /* --- Control Button Styles --- */
        .control-btn {
            color: var(--color-text-light);
            border: none;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s, background-color 0.5s, box-shadow 0.5s;
            width: 100%; 
        }
        .control-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--color-primary) !important; 
        }
        #game-controls { margin-top: 1rem; width: 100%; }
        
        /* **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà 1: ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (‡∏Ç‡∏ì‡∏∞‡πÄ‡∏•‡πà‡∏ô)** */
        #play-controls { 
            display: flex; 
            gap: 10px; 
            width: 100%; 
        }
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏° (100%) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
        #play-controls .control-btn { 
            width: 100%; 
        }
        
        #end-game-controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            width: 100%; 
        }
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î 100% */
        #end-game-controls .control-btn { 
            width: 100%; 
        }

        .success-btn {
            background-color: var(--color-correct);
            box-shadow: 0 4px 0 #558B2F;
        }
        .secondary-btn {
            background-color: #607D8B; 
            box-shadow: 0 4px 0 #455A64;
        }

        #message-area {
            min-height: 2rem;
            font-weight: bold;
            margin-top: 1rem;
            color: var(--color-secondary);
            transition: color 0.5s;
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <header id="game-header">
            <h1>Word Icons Match üß†</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (12 Levels)</h2>
            <p>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="level-grid-select">
                </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="status-bar">
                <span id="level-info">Level 1: 4x3</span>
                <span id="flips">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                <span id="timer">‡πÄ‡∏ß‡∏•‡∏≤: 0.00 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
            </div>
            
            <div id="game-grid">
                </div>
            
            <div id="message-area"></div>
            
            <div id="game-controls">
                <div id="play-controls" style="display: flex;">
                    <button id="main-menu-btn-play" class="control-btn secondary-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button>
                </div>

                <div id="end-game-controls" style="display: none; margin-top: 10px;">
                    <button id="play-again-btn" class="control-btn success-btn">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ) üîÑ</button>
                    <button id="next-level-btn" class="control-btn">Level ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è</button>
                    <button id="main-menu-btn-end" class="control-btn secondary-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button> 
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: 84 Pairs for 12 Levels (4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà) ---
        const ALL_WORDS_DATA = [
            // L1-L4: 4x3 (6 Pairs x 4 Levels = 24 Pairs)
            // L1
            { word: "CAT", icon: "üê±", matchId: 1 }, { word: "DOG", icon: "üê∂", matchId: 2 }, { word: "CAR", icon: "üöó", matchId: 3 },
            { word: "SUN", icon: "‚òÄÔ∏è", matchId: 4 }, { word: "TREE", icon: "üå≥", matchId: 5 }, { word: "BALL", icon: "‚öΩ", matchId: 6 },
            // L2
            { word: "APPLE", icon: "üçé", matchId: 7 }, { word: "BANANA", icon: "üçå", matchId: 8 }, { word: "RED", icon: "üî¥", matchId: 9 },
            { word: "BLUE", icon: "üîµ", matchId: 10 }, { word: "HOUSE", icon: "üè†", matchId: 11 }, { word: "CLOCK", icon: "‚è∞", matchId: 12 },
            // L3
            { word: "WALK", icon: "üö∂", matchId: 13 }, { word: "RUN", icon: "üèÉ", matchId: 14 }, { word: "SIT", icon: "ü™ë", matchId: 15 },
            { word: "SLEEP", icon: "üò¥", matchId: 16 }, { word: "DRINK", icon: "ü•õ", matchId: 17 }, { word: "EAT", icon: "üçΩÔ∏è", matchId: 18 },
            // L4
            { word: "GIFT", icon: "üéÅ", matchId: 19 }, { word: "LOVE", icon: "‚ù§Ô∏è", matchId: 20 }, { word: "HAPPY", icon: "üòä", matchId: 21 }, 
            { word: "SAD", icon: "üòî", matchId: 22 }, { word: "SHOCK", icon: "üò≤", matchId: 23 }, { word: "IDEA", icon: "üí°", matchId: 24 },
            
            // L5-L8: 4x4 (8 Pairs x 4 Levels = 32 Pairs)
            // L5
            { word: "MONEY", icon: "üí∞", matchId: 25 }, { word: "TICKET", icon: "üé´", matchId: 26 }, { word: "PEN", icon: "üñäÔ∏è", matchId: 27 }, 
            { word: "KEY", icon: "üîë", matchId: 28 }, { word: "CUP", icon: "‚òï", matchId: 29 }, { word: "FLAG", icon: "üö©", matchId: 30 },
            { word: "WATER", icon: "üíß", matchId: 31 }, { word: "FIRE", icon: "üî•", matchId: 32 },
            // L6
            { word: "CLOUD", icon: "‚òÅÔ∏è", matchId: 33 }, { word: "RAIN", icon: "üåßÔ∏è", matchId: 34 }, { word: "SNOW", icon: "‚ùÑÔ∏è", matchId: 35 }, 
            { word: "FLOWER", icon: "üå∏", matchId: 36 }, { word: "MOUNTAIN", icon: "‚õ∞Ô∏è", matchId: 37 }, { word: "MOON", icon: "üåï", matchId: 38 },
            { word: "ROAD", icon: "üõ£Ô∏è", matchId: 39 }, { word: "BOAT", icon: "‚õµ", matchId: 40 },
            // L7
            { word: "DOCTOR", icon: "üßë‚Äç‚öïÔ∏è", matchId: 41 }, { word: "POLICE", icon: "üëÆ", matchId: 42 }, { word: "STUDENT", icon: "üßë‚Äçüéì", matchId: 43 }, 
            { word: "CHEF", icon: "üßë‚Äçüç≥", matchId: 44 }, { word: "KING", icon: "üëë", matchId: 45 }, { word: "FAMILY", icon: "üë™", matchId: 46 },
            { word: "BABY", icon: "üë∂", matchId: 47 }, { word: "HAND", icon: "‚úã", matchId: 48 },
            // L8
            { word: "EYE", icon: "üëÅÔ∏è", matchId: 49 }, { word: "EAR", icon: "üëÇ", matchId: 50 }, { word: "DESK", icon: "üñ•Ô∏è", matchId: 51 }, 
            { word: "MOUSE", icon: "üñ±Ô∏è", matchId: 52 }, { word: "EMAIL", icon: "üìß", matchId: 53 }, { word: "CALENDAR", icon: "üìÖ", matchId: 54 },
            { word: "TRUCK", icon: "üöö", matchId: 55 }, { word: "BUS", icon: "üöå", matchId: 56 },
            
            // L9-L10: 4x5 (10 Pairs x 2 Levels = 20 Pairs)
            // L9
            { word: "WINE", icon: "üç∑", matchId: 57 }, { word: "BEER", icon: "üç∫", matchId: 58 }, { word: "PIZZA", icon: "üçï", matchId: 59 }, 
            { word: "SHIRT", icon: "üëï", matchId: 60 }, { word: "CAMERA", icon: "üì∑", matchId: 61 }, { word: "VIDEO", icon: "üìπ", matchId: 62 }, 
            { word: "NOTE", icon: "üìù", matchId: 63 }, { word: "CALCULATE", icon: "üßÆ", matchId: 64 }, { word: "GLOBE", icon: "üåç", matchId: 65 }, 
            { word: "BAG", icon: "üëú", matchId: 66 },
            // L10 
            { word: "BIKE", icon: "üö≤", matchId: 67 }, { word: "TRAIN", icon: "üöÇ", matchId: 68 }, { word: "TENT", icon: "‚õ∫", matchId: 69 }, 
            { word: "WIFI", icon: "üì∂", matchId: 70 }, { word: "LOCK", icon: "üîí", matchId: 71 }, { word: "UNLOCK", icon: "üîì", matchId: 72 },
            { word: "ARROW", icon: "‚¨ÜÔ∏è", matchId: 73 }, { word: "DOWN", icon: "‚¨áÔ∏è", matchId: 74 }, { word: "PLUS", icon: "‚ûï", matchId: 75 }, 
            { word: "MINUS", icon: "‚ûñ", matchId: 76 },
            
            // L11-L12: 4x6 (12 Pairs x 2 Levels = 24 Pairs) - NEW WORDS ADDED
            // L11
            { word: "KEYBOARD", icon: "‚å®Ô∏è", matchId: 77 }, { word: "PRINTER", icon: "üñ®Ô∏è", matchId: 78 }, { word: "MUTE", icon: "üîá", matchId: 79 }, 
            { word: "VOLUME", icon: "üîä", matchId: 80 }, { word: "LIGHT", icon: "üí°", matchId: 81 }, { word: "DARK", icon: "üåë", matchId: 82 }, 
            { word: "CHAIR", icon: "ü™ë", matchId: 83 }, { word: "TABLE", icon: "ü™ö", matchId: 84 }, { word: "EARTH", icon: "üåé", matchId: 85 }, 
            { word: "MARS", icon: "üî¥", matchId: 86 }, { word: "RING", icon: "üíç", matchId: 87 }, { word: "DIAMOND", icon: "üíé", matchId: 88 },
            // L12
            { word: "SHIELD", icon: "üõ°Ô∏è", matchId: 89 }, { word: "SWORD", icon: "‚öîÔ∏è", matchId: 90 }, { word: "CROWN", icon: "üëë", matchId: 91 }, 
            { word: "CASTLE", icon: "üè∞", matchId: 92 }, { word: "GHOST", icon: "üëª", matchId: 93 }, { word: "WITCH", icon: "üßô", matchId: 94 },
            { word: "ZOMBIE", icon: "üßü", matchId: 95 }, { word: "VAMPIRE", icon: "üßõ", matchId: 96 }, { word: "ROBOT", icon: "ü§ñ", matchId: 97 }, 
            { word: "ALIEN", icon: "üëΩ", matchId: 98 }, { word: "FIREMAN", icon: "üë®‚Äçüöí", matchId: 99 }, { word: "PILOT", icon: "üßë‚Äç‚úàÔ∏è", matchId: 100 } 
        ];
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå 84 ‡∏Ñ‡∏π‡πà (168 ‡∏Å‡∏≤‡∏£‡πå‡∏î) ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô 12 Levels
        const newLevels = [
            { level: 1, gridSize: '4x3', words: ALL_WORDS_DATA.slice(0, 6) },
            { level: 2, gridSize: '4x3', words: ALL_WORDS_DATA.slice(6, 12) },
            { level: 3, gridSize: '4x3', words: ALL_WORDS_DATA.slice(12, 18) },
            { level: 4, gridSize: '4x3', words: ALL_WORDS_DATA.slice(18, 24) },
            
            { level: 5, gridSize: '4x4', words: ALL_WORDS_DATA.slice(24, 32) },
            { level: 6, gridSize: '4x4', words: ALL_WORDS_DATA.slice(32, 40) },
            { level: 7, gridSize: '4x4', words: ALL_WORDS_DATA.slice(40, 48) },
            { level: 8, gridSize: '4x4', words: ALL_WORDS_DATA.slice(48, 56) },
            
            { level: 9, gridSize: '4x5', words: ALL_WORDS_DATA.slice(56, 66) },
            { level: 10, gridSize: '4x5', words: ALL_WORDS_DATA.slice(66, 76) },
            
            { level: 11, gridSize: '4x6', words: ALL_WORDS_DATA.slice(76, 88) }, /* New Level 11 (12 Pairs) */
            { level: 12, gridSize: '4x6', words: ALL_WORDS_DATA.slice(88, 100) }  /* New Level 12 (12 Pairs) */
        ];

        // --- GAME STATE & ELEMENTS ---
        let currentLevel = null;
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalFlips = 0;
        let score = 0;
        let gameLocked = false; 
        let timerInterval = null;
        let timeElapsed = 0;
        let startTime = 0;
        let isSpeaking = false; 

        const mainContainerEl = document.getElementById('main-container');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameGridEl = document.getElementById('game-grid');
        const levelInfoEl = document.getElementById('level-info');
        const flipsEl = document.getElementById('flips');
        const timerEl = document.getElementById('timer');
        const messageAreaEl = document.getElementById('message-area');
        const endGameControlsEl = document.getElementById('end-game-controls');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const levelGridSelectEl = document.getElementById('level-grid-select');
        const mainMenuBtnEnd = document.getElementById('main-menu-btn-end');
        
        // --- SPEECH & SOUND FUNCTIONS (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
        let utterance = null;
        function setupSpeech() {
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.volume = 1; 
                utterance.rate = 0.8; 
                utterance.pitch = 1;
                utterance.lang = 'en-US';
                window.speechSynthesis.getVoices(); 
            }
        }

        function speakWord(text, callback = null) {
            if (utterance) {
                window.speechSynthesis.cancel();
                utterance.text = text;
                const voices = window.speechSynthesis.getVoices();
                utterance.voice = voices.find(v => v.lang.startsWith('en-US') || v.lang.startsWith('en-GB') || v.lang.startsWith('en-')); 
                isSpeaking = true;
                utterance.onend = () => {
                    isSpeaking = false;
                    if (callback) callback();
                };
                try {
                    window.speechSynthesis.speak(utterance); 
                } catch(e) {
                    isSpeaking = false;
                    if (callback) callback();
                }
            } else {
                if (callback) callback();
            }
        }

        function playSound(type) {
            if (typeof AudioContext === 'undefined') return;

            const context = new AudioContext();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            if (type === 'success') {
                oscillator.type = 'square'; 
                oscillator.frequency.setValueAtTime(880, context.currentTime); 
                gainNode.gain.setValueAtTime(0.5, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.3);
            } else if (type === 'error') {
                oscillator.type = 'sawtooth'; 
                oscillator.frequency.setValueAtTime(150, context.currentTime); 
                gainNode.gain.setValueAtTime(0.4, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.4);
            }

            oscillator.start();
            oscillator.stop(context.currentTime + 0.4);
        }

        // --- HELPER FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showScreen(id) {
            window.speechSynthesis.cancel();
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function updateStats() {
            flipsEl.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        
        function startTimer() {
             startTime = performance.now();
             clearInterval(timerInterval);
             timerInterval = setInterval(() => {
                 timeElapsed = (performance.now() - startTime) / 1000;
                 timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
             }, 100);
        }

        function stopTimer() {
             clearInterval(timerInterval);
        }

        /* --- Level Button Creation (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏° Level ‡πÉ‡∏´‡∏°‡πà) --- */
        function createLevelButtons() {
            levelGridSelectEl.innerHTML = '';
            
            newLevels.forEach(data => { 
                const btn = document.createElement('button');
                btn.className = 'control-btn';
                btn.textContent = `Level ${data.level} (${data.words.length} ‡∏Ñ‡∏π‡πà - ${data.gridSize})`;
                btn.setAttribute('data-level', data.level);
                
                let btnBgColor;
                let btnShadowColor;
                
                // ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° Level: L1-L4 (Blue), L5-L8 (Violet), L9-L10 (Orange), L11-L12 (Teal)
                if (data.level >= 1 && data.level <= 4) {
                    btnBgColor = '#1976D2'; 
                    btnShadowColor = '#1565C0'; 
                } else if (data.level >= 5 && data.level <= 8) {
                    btnBgColor = '#8E24AA'; 
                    btnShadowColor = '#6A1B9A';
                } else if (data.level >= 9 && data.level <= 10) {
                    btnBgColor = '#FF9800'; 
                    btnShadowColor = '#F57C00';
                } else if (data.level >= 11 && data.level <= 12) {
                    btnBgColor = '#00796B'; 
                    btnShadowColor = '#004D40'; 
                }

                btn.style.backgroundColor = btnBgColor;
                btn.style.boxShadow = `0 4px 0 ${btnShadowColor}`;

                btn.addEventListener('click', () => {
                    startGame(data.level);
                });
                levelGridSelectEl.appendChild(btn);
            });
        }
        
        function setupCards(levelData) {
            const wordPairs = levelData.words;
            cards = [];

            wordPairs.forEach(pair => {
                cards.push({ content: pair.word, type: 'word', matchId: pair.matchId });
                cards.push({ content: pair.icon, type: 'icon', matchId: pair.matchId });
            });

            cards = shuffleArray(cards);

            gameGridEl.innerHTML = '';
            const [cols, rows] = levelData.gridSize.split('x').map(Number); 
            
            gameGridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameGridEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            cards.forEach((cardData, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.setAttribute('data-index', index);
                cardEl.setAttribute('data-match-id', cardData.matchId);
                cardEl.addEventListener('click', handleCardClick);

                const cardInner = document.createElement('div');
                cardInner.className = 'card-inner';

                const cardFront = document.createElement('div');
                cardFront.className = 'card-front';
                
                if (cardData.type === 'word') {
                     cardFront.textContent = cardData.content;
                } else {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'card-content-icon';
                    iconSpan.textContent = cardData.content;
                    cardFront.appendChild(iconSpan);
                }

                const cardBack = document.createElement('div');
                cardBack.className = 'card-back';
                cardBack.textContent = '?';

                cardInner.appendChild(cardBack);
                cardInner.appendChild(cardFront);
                cardEl.appendChild(cardInner);
                gameGridEl.appendChild(cardEl);
            });
        }
        
        function goToLevelSelect() {
            stopTimer();
            showScreen('level-select-screen');
        }


        // --- GAME FLOW ---
        
        function applyLevelTheme(level) {
            mainContainerEl.classList.remove('level-5-8-theme', 'level-9-10-theme', 'level-11-12-theme');
            // ‡∏ò‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà: L1-L4 (Blue), L5-L8 (Violet), L9-L10 (Orange), L11-L12 (Teal)
            if (level >= 5 && level <= 8) {
                mainContainerEl.classList.add('level-5-8-theme');
            } else if (level >= 9 && level <= 10) {
                mainContainerEl.classList.add('level-9-10-theme');
            } else if (level >= 11 && level <= 12) {
                mainContainerEl.classList.add('level-11-12-theme');
            } else {
                 mainContainerEl.classList.remove('level-5-8-theme', 'level-9-10-theme', 'level-11-12-theme');
            }
        }
        
        function startGame(level) {
            currentLevel = level;
            const levelData = newLevels.find(d => d.level === level); 
            if (!levelData) { console.error("Level data not found:", level); return; }
            
            applyLevelTheme(level);

            matchedPairs = 0;
            totalFlips = 0;
            gameLocked = false;
            timeElapsed = 0;
            updateStats();
            messageAreaEl.textContent = "";
            messageAreaEl.style.fontSize = '1rem';
            
            // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡∏ã‡πà‡∏≠‡∏ô end-game-controls ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á play-controls
            endGameControlsEl.style.display = 'none';
            document.getElementById('play-controls').style.display = 'flex';
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° 100% (CSS ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß)
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Next Level ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Level ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            if (currentLevel === newLevels.length) {
                 nextLevelBtn.style.display = 'none';
            } else {
                 nextLevelBtn.style.display = 'block'; 
            }
            
            window.speechSynthesis.cancel(); 

            levelInfoEl.textContent = `Level ${level}: ${levelData.gridSize}`;
            
            setupCards(levelData);
            showScreen('game-screen');
            startTimer();
        }

        function handleCardClick(event) {
            if (gameLocked || isSpeaking) return; 
            
            const cardEl = event.currentTarget;
            const cardIndex = parseInt(cardEl.getAttribute('data-index'));
            const cardData = cards[cardIndex];

            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
            
            cardEl.classList.add('flipped');
            flippedCards.push({ cardEl, cardData });
            
            if (flippedCards.length === 2) {
                gameLocked = true;
                totalFlips++;
                updateStats();
                checkForMatch();
            }
        }

        function checkForMatch() {
            const card1 = flippedCards[0].cardData;
            const card2 = flippedCards[1].cardData;
            const card1El = flippedCards[0].cardEl;
            const card2El = flippedCards[1].cardEl;
            
            const isMatch = (card1.matchId === card2.matchId) && (card1.type !== card2.type);
            const wordToSpeak = card1.type === 'word' ? card1.content : card2.content;
            const currentLevelData = newLevels.find(d => d.level === currentLevel); 


            if (isMatch) {
                // SUCCESS
                score += 1; 
                matchedPairs++;
                
                playSound('success');
                
                card1El.classList.add('matched-correct');
                card2El.classList.add('matched-correct');
                
                messageAreaEl.textContent = `üéâ MATCH! (${wordToSpeak}) ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà ${matchedPairs}/${currentLevelData.words.length}`;
                messageAreaEl.style.color = 'var(--color-correct)';
                
                speakWord(wordToSpeak, () => {
                    setTimeout(() => {
                        card1El.classList.add('matched');
                        card2El.classList.add('matched');
                        
                        card1El.classList.remove('matched-correct');
                        card2El.classList.remove('matched-correct');
                        
                        gameLocked = false;
                        flippedCards = [];
                        checkWinCondition();
                    }, 1000); 
                });
                
            } else {
                // ERROR
                playSound('error'); 
                
                const inner1 = card1El.querySelector('.card-inner');
                const inner2 = card2El.querySelector('.card-inner');
                
                inner1.classList.add('shake-error');
                inner2.classList.add('shake-error');
                
                messageAreaEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                messageAreaEl.style.color = 'var(--color-wrong)';
                
                setTimeout(() => {
                    card1El.classList.remove('flipped');
                    card2El.classList.remove('flipped');
                    
                    inner1.classList.remove('shake-error');
                    inner2.classList.remove('shake-error');
                    
                    gameLocked = false;
                    flippedCards = [];
                }, 1200);
            }
        }

        function checkWinCondition() {
            const currentLevelData = newLevels.find(d => d.level === currentLevel);
            const totalPairs = currentLevelData ? currentLevelData.words.length : 0;
            
            if (matchedPairs === totalPairs) {
                stopTimer();
                window.speechSynthesis.cancel();
                messageAreaEl.textContent = `üèÜ ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!`;
                messageAreaEl.style.fontSize = '1.2rem';
                messageAreaEl.style.color = 'var(--color-primary)';
                
                // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡∏ã‡πà‡∏≠‡∏ô play-controls ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á end-game-controls
                document.getElementById('play-controls').style.display = 'none';
                endGameControlsEl.style.display = 'flex';
                
                if (currentLevel === newLevels.length) {
                    nextLevelBtn.style.display = 'none';
                    messageAreaEl.textContent += ` (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Level ‡πÅ‡∏•‡πâ‡∏ß!)`;
                } else {
                    nextLevelBtn.style.display = 'block';
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
                mainMenuBtnEnd.style.display = 'block';
            }
        }

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeech();
            createLevelButtons(); 

            // Bind Control Buttons
            document.getElementById('main-menu-btn-play').addEventListener('click', goToLevelSelect);
            
            // Bind ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
            document.getElementById('main-menu-btn-end').addEventListener('click', goToLevelSelect); 
            
            document.getElementById('play-again-btn').addEventListener('click', () => {
                startGame(currentLevel); 
            });
            document.getElementById('next-level-btn').addEventListener('click', () => {
                if (currentLevel < newLevels.length) {
                    startGame(currentLevel + 1);
                } else {
                    goToLevelSelect();
                }
            });

            // Bind level selection click handler
            levelGridSelectEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.closest('#level-grid-select')) {
                    const levelId = parseInt(e.target.getAttribute('data-level'));
                    if (!isNaN(levelId)) {
                        startGame(levelId);
                    }
                }
            });

            showScreen('level-select-screen');
        });
    </script>
</body>
</html>
