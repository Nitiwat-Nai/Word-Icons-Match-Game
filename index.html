<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Icons Match üß†</title> 
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL THEME SETUP --- */
        :root {
            /* Fallback Colors (L1-L3: Blue Theme) */
            --color-primary: #1976D2; /* Dark Blue */
            --color-secondary: #00BCD4; /* Cyan/Accent */
            --color-card-front: #BBDEFB; /* Light Blue */
            --color-card-back: #1976D2; 
            --color-text-light: #FFFFFF;
            
            --color-correct: #8BC34A; /* Lime Green */
            --color-wrong: #F44336; /* Red */
            --color-bg: #E3F2FD; /* Lighter Blue Background */
            --color-text-dark: #263238;
        }
        
        /* Level 4-6 Theme: Pink/Violet */
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level 4-5 (‡∏ï‡∏≤‡∏° Level ‡πÉ‡∏´‡∏°‡πà) */
        .level-4-6-theme {
            --color-primary: #8E24AA; /* Dark Violet */
            --color-secondary: #FF4081; /* Pink/Accent */
            --color-card-front: #F8BBD0; /* Light Pink */
            --color-card-back: #8E24AA; 
            --color-bg: #FCE4EC; /* Lighter Pink Background */
        }
        
        /* Level 7-10 Theme: Yellow/Orange (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢) */
        .level-7-10-theme {
            --color-primary: #FF9800; /* Orange */
            --color-secondary: #FFEB3B; /* Yellow/Accent */
            --color-card-front: #FFE0B2; /* Light Orange */
            --color-card-back: #FF9800; 
            --color-bg: #FFF3E0; /* Lighter Orange Background */
        }

        /* --- CONTAINER & BASE STYLES --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            background-color: #FFFFFF;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            transition: background-color 0.5s;
        }

        header {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            padding: 1rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.5s;
        }
        header h1 { font-size: 1.8rem; margin: 0; } 
        
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: flex-start; 
            gap: 15px;
        }
        .screen.active { display: flex; }

        .status-bar {
             display: flex;
             justify-content: space-around;
             padding: 10px 0;
             font-weight: bold;
             font-size: 1rem;
             color: var(--color-primary);
             transition: color 0.5s;
        }
        
        #level-grid-select {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 15px;
             padding: 0.5rem 0;
        }

        /* --- Card Grid and Card Styles --- */
        #game-grid {
            width: 95%;
            margin: 1rem auto;
            display: grid;
            gap: 10px;
        }
        
        /* **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö Card Size ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏•‡∏≠‡∏î** */
        .card {
            height: 85px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4x6 */
            perspective: 1000px; 
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
        }

        /* Card Flip Animation */
        .card.flipped .card-inner { transform: rotateY(180deg); }

        .card-inner {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            position: relative; 
        }

        /* Shake Effect for Error */
        @keyframes card-shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-2px, 0) rotate(-1deg); }
            30% { transform: translate(2px, 0) rotate(0deg); }
            50% { transform: translate(-2px, 0) rotate(1deg); }
            70% { transform: translate(2px, 0) rotate(-1deg); }
            90% { transform: translate(-2px, 0) rotate(0deg); }
        }
        .card-inner.shake-error {
            animation: card-shake 0.5s ease-in-out;
        }
        
        /* Jump Effect for Match */
        .card.matched-correct {
            animation: jump 0.8s ease-out;
        }
        @keyframes jump {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
            50% { transform: scale(1.08) translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-weight: 700;
            padding: 5px;
            box-sizing: border-box;
            text-align: center;
        }

        .card-back {
            background-color: var(--color-card-back);
            color: var(--color-text-light);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,.2) 0px, rgba(255,255,255,.2) 1px, transparent 1px, transparent 10px);
            border: 3px solid var(--color-primary);
            font-size: 1.5rem;
        }

        .card-front {
            background-color: var(--color-card-front);
            color: var(--color-text-dark);
            transform: rotateY(180deg);
            border: 3px solid var(--color-secondary);
            font-size: 1.1rem; 
        }
        
        .card-content-icon {
            font-size: 2.5rem; 
        }
        
        .card.matched .card-inner {
            box-shadow: 0 0 15px var(--color-correct);
            opacity: 0.5;
            cursor: default;
        }
        .card.matched .card-front {
             border-color: var(--color-correct);
        }

        /* --- Control Button Styles (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° Level) --- */
        .control-btn {
            color: var(--color-text-light);
            border: none;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s, background-color 0.5s, box-shadow 0.5s;
            width: 100%; 
        }
        .control-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--color-primary) !important; 
        }
        #game-controls { margin-top: 1rem; width: 100%; }
        #play-controls { display: flex; gap: 10px; width: 100%; }
        #play-controls .control-btn { width: 50%; }
        #end-game-controls { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .success-btn {
            background-color: var(--color-correct);
            box-shadow: 0 4px 0 #558B2F;
        }
        .secondary-btn {
            background-color: #607D8B; 
            box-shadow: 0 4px 0 #455A64;
        }

        #message-area {
            min-height: 2rem;
            font-weight: bold;
            margin-top: 1rem;
            color: var(--color-secondary);
            transition: color 0.5s;
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <header id="game-header">
            <h1>Word Icons Match üß†</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (5 Levels)</h2>
            <p>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="level-grid-select">
                </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="status-bar">
                <span id="level-info">Level 1: 4x3</span>
                <span id="flips">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                <span id="timer">‡πÄ‡∏ß‡∏•‡∏≤: 0.00 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
            </div>
            
            <div id="game-grid">
                </div>
            
            <div id="message-area"></div>
            
            <div id="game-controls">
                <div id="play-controls" style="display: flex;">
                    <button id="main-menu-btn-play" class="control-btn secondary-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button>
                </div>

                <div id="end-game-controls" style="display: none; margin-top: 10px;">
                    <button id="play-again-btn" class="control-btn success-btn">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ) üîÑ</button>
                    <button id="next-level-btn" class="control-btn">Level ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: 5 Levels ‡πÉ‡∏´‡∏°‡πà (4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà) ---
        const ALL_WORDS_DATA = [
            // 48 ‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°
            // L1: CAT, DOG, CAR, SUN, TREE, BALL (6 Pairs)
            { word: "CAT", icon: "üê±", matchId: 1 }, { word: "DOG", icon: "üê∂", matchId: 2 }, { word: "CAR", icon: "üöó", matchId: 3 },
            { word: "SUN", icon: "‚òÄÔ∏è", matchId: 4 }, { word: "TREE", icon: "üå≥", matchId: 5 }, { word: "BALL", icon: "‚öΩ", matchId: 6 },
            
            // L2: APPLE, BANANA, RED, BLUE, HOUSE, CLOCK, BOOK, STAR (8 Pairs)
            { word: "APPLE", icon: "üçé", matchId: 7 }, { word: "BANANA", icon: "üçå", matchId: 8 }, { word: "RED", icon: "üî¥", matchId: 9 },
            { word: "BLUE", icon: "üîµ", matchId: 10 }, { word: "HOUSE", icon: "üè†", matchId: 11 }, { word: "CLOCK", icon: "‚è∞", matchId: 12 },
            { word: "BOOK", icon: "üìö", matchId: 13 }, { word: "STAR", icon: "‚≠ê", matchId: 14 },
            
            // L3: WALK, RUN, SIT, SLEEP, DRINK, EAT, GIFT, LOVE, HAPPY, SAD (10 Pairs)
            { word: "WALK", icon: "üö∂", matchId: 15 }, { word: "RUN", icon: "üèÉ", matchId: 16 }, { word: "SIT", icon: "ü™ë", matchId: 17 },
            { word: "SLEEP", icon: "üò¥", matchId: 18 }, { word: "DRINK", icon: "ü•õ", matchId: 19 }, { word: "EAT", icon: "üçΩÔ∏è", matchId: 20 },
            { word: "GIFT", icon: "üéÅ", matchId: 21 }, { word: "LOVE", icon: "‚ù§Ô∏è", matchId: 22 }, 
            { word: "HAPPY", icon: "üòä", matchId: 23 }, { word: "SAD", icon: "üòî", matchId: 24 },
            
            // L4: SHOCK, IDEA, MONEY, TICKET, PEN, KEY, CUP, FLAG, WATER, FIRE, CLOUD, RAIN (12 Pairs)
            { word: "SHOCK", icon: "üò≤", matchId: 25 }, { word: "IDEA", icon: "üí°", matchId: 26 }, { word: "MONEY", icon: "üí∞", matchId: 27 }, 
            { word: "TICKET", icon: "üé´", matchId: 28 }, { word: "PEN", icon: "üñäÔ∏è", matchId: 29 }, { word: "KEY", icon: "üîë", matchId: 30 }, 
            { word: "CUP", icon: "‚òï", matchId: 31 }, { word: "FLAG", icon: "üö©", matchId: 32 }, 
            { word: "WATER", icon: "üíß", matchId: 33 }, { word: "FIRE", icon: "üî•", matchId: 34 }, { word: "CLOUD", icon: "‚òÅÔ∏è", matchId: 35 },
            { word: "RAIN", icon: "üåßÔ∏è", matchId: 36 },
            
            // L5: SNOW, FLOWER, MOUNTAIN, MOON, ROAD, BOAT, DOCTOR, POLICE, STUDENT, CHEF, KING, FAMILY (12 Pairs)
            { word: "SNOW", icon: "‚ùÑÔ∏è", matchId: 37 }, { word: "FLOWER", icon: "üå∏", matchId: 38 },
            { word: "MOUNTAIN", icon: "‚õ∞Ô∏è", matchId: 39 }, { word: "MOON", icon: "üåï", matchId: 40 }, { word: "ROAD", icon: "üõ£Ô∏è", matchId: 41 }, 
            { word: "BOAT", icon: "‚õµ", matchId: 42 }, { word: "DOCTOR", icon: "üßë‚Äç‚öïÔ∏è", matchId: 43 }, { word: "POLICE", icon: "üëÆ", matchId: 44 }, 
            { word: "STUDENT", icon: "üßë‚Äçüéì", matchId: 45 }, { word: "CHEF", icon: "üßë‚Äçüç≥", matchId: 46 }, { word: "KING", icon: "üëë", matchId: 47 }, 
            { word: "FAMILY", icon: "üë™", matchId: 48 }
        ];

        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏≤‡∏° Level ‡πÉ‡∏´‡∏°‡πà (4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)
        const newLevels = [
            { level: 1, gridSize: '4x3', words: ALL_WORDS_DATA.slice(0, 6) },  // 6 Pairs
            { level: 2, gridSize: '4x4', words: ALL_WORDS_DATA.slice(6, 14) }, // 8 Pairs
            { level: 3, gridSize: '4x5', words: ALL_WORDS_DATA.slice(14, 24) }, // 10 Pairs
            { level: 4, gridSize: '4x6', words: ALL_WORDS_DATA.slice(24, 36) }, // 12 Pairs
            { level: 5, gridSize: '4x6', words: ALL_WORDS_DATA.slice(36, 48) }  // 12 Pairs
        ];

        // --- GAME STATE & ELEMENTS ---
        let currentLevel = null;
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalFlips = 0;
        let score = 0;
        let gameLocked = false; 
        let timerInterval = null;
        let timeElapsed = 0;
        let startTime = 0;
        let isSpeaking = false; 

        const mainContainerEl = document.getElementById('main-container');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameGridEl = document.getElementById('game-grid');
        const levelInfoEl = document.getElementById('level-info');
        const flipsEl = document.getElementById('flips');
        const timerEl = document.getElementById('timer');
        const messageAreaEl = document.getElementById('message-area');
        const endGameControlsEl = document.getElementById('end-game-controls');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const levelGridSelectEl = document.getElementById('level-grid-select');
        
        // --- SPEECH & SOUND FUNCTIONS (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
        let utterance = null;
        function setupSpeech() {
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.volume = 1; 
                utterance.rate = 0.8; 
                utterance.pitch = 1;
                utterance.lang = 'en-US';
                window.speechSynthesis.getVoices(); 
            }
        }

        function speakWord(text, callback = null) {
            if (utterance) {
                window.speechSynthesis.cancel();
                utterance.text = text;
                const voices = window.speechSynthesis.getVoices();
                utterance.voice = voices.find(v => v.lang.startsWith('en-US') || v.lang.startsWith('en-GB') || v.lang.startsWith('en-')); 
                isSpeaking = true;
                utterance.onend = () => {
                    isSpeaking = false;
                    if (callback) callback();
                };
                try {
                    window.speechSynthesis.speak(utterance); 
                } catch(e) {
                    isSpeaking = false;
                    if (callback) callback();
                }
            } else {
                if (callback) callback();
            }
        }

        function playSound(type) {
            if (typeof AudioContext === 'undefined') return;

            const context = new AudioContext();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            if (type === 'success') {
                oscillator.type = 'square'; 
                oscillator.frequency.setValueAtTime(880, context.currentTime); 
                gainNode.gain.setValueAtTime(0.5, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.3);
            } else if (type === 'error') {
                oscillator.type = 'sawtooth'; 
                oscillator.frequency.setValueAtTime(150, context.currentTime); 
                gainNode.gain.setValueAtTime(0.4, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.4);
            }

            oscillator.start();
            oscillator.stop(context.currentTime + 0.4);
        }

        // --- HELPER FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showScreen(id) {
            window.speechSynthesis.cancel();
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function updateStats() {
            flipsEl.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        
        function startTimer() {
             startTime = performance.now();
             clearInterval(timerInterval);
             timerInterval = setInterval(() => {
                 timeElapsed = (performance.now() - startTime) / 1000;
                 timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
             }, 100);
        }

        function stopTimer() {
             clearInterval(timerInterval);
        }

        /* --- Level Button Creation (‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏° Level ‡πÉ‡∏´‡∏°‡πà) --- */
        function createLevelButtons() {
            levelGridSelectEl.innerHTML = '';
            // ‡πÉ‡∏ä‡πâ newLevels ‡πÅ‡∏ó‡∏ô allWords
            newLevels.forEach(data => { 
                const btn = document.createElement('button');
                btn.className = 'control-btn';
                btn.textContent = `Level ${data.level} (${data.words.length} ‡∏Ñ‡∏π‡πà - ${data.gridSize})`;
                btn.setAttribute('data-level', data.level);
                
                let btnBgColor;
                let btnShadowColor;
                
                // ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° Level: 1-2 ‡∏™‡∏µ‡∏ü‡πâ‡∏≤, 3-4 ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á, 5-N ‡∏™‡∏µ‡∏™‡πâ‡∏°
                if (data.level >= 1 && data.level <= 2) {
                    btnBgColor = '#1976D2'; // Dark Blue
                    btnShadowColor = '#1565C0'; 
                } else if (data.level >= 3 && data.level <= 4) {
                    btnBgColor = '#8E24AA'; // Dark Violet
                    btnShadowColor = '#6A1B9A';
                } else if (data.level >= 5) {
                    btnBgColor = '#FF9800'; // Orange
                    btnShadowColor = '#F57C00';
                }

                btn.style.backgroundColor = btnBgColor;
                btn.style.boxShadow = `0 4px 0 ${btnShadowColor}`;

                btn.addEventListener('click', () => {
                    startGame(data.level);
                });
                levelGridSelectEl.appendChild(btn);
            });
        }
        
        function setupCards(levelData) {
            const wordPairs = levelData.words;
            cards = [];

            wordPairs.forEach(pair => {
                cards.push({ content: pair.word, type: 'word', matchId: pair.matchId });
                cards.push({ content: pair.icon, type: 'icon', matchId: pair.matchId });
            });

            cards = shuffleArray(cards);

            gameGridEl.innerHTML = '';
            // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏´‡∏•‡∏î gridSize ‡∏à‡∏≤‡∏Å Level Data ‡πÉ‡∏´‡∏°‡πà**
            const [cols, rows] = levelData.gridSize.split('x').map(Number); 
            
            gameGridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameGridEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            cards.forEach((cardData, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.setAttribute('data-index', index);
                cardEl.setAttribute('data-match-id', cardData.matchId);
                cardEl.addEventListener('click', handleCardClick);

                const cardInner = document.createElement('div');
                cardInner.className = 'card-inner';

                const cardFront = document.createElement('div');
                cardFront.className = 'card-front';
                
                if (cardData.type === 'word') {
                     cardFront.textContent = cardData.content;
                } else {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'card-content-icon';
                    iconSpan.textContent = cardData.content;
                    cardFront.appendChild(iconSpan);
                }

                const cardBack = document.createElement('div');
                cardBack.className = 'card-back';
                cardBack.textContent = '?';

                cardInner.appendChild(cardBack);
                cardInner.appendChild(cardFront);
                cardEl.appendChild(cardInner);
                gameGridEl.appendChild(cardEl);
            });
        }
        
        function goToLevelSelect() {
            showScreen('level-select-screen');
        }


        // --- GAME FLOW ---
        
        function applyLevelTheme(level) {
            mainContainerEl.classList.remove('level-4-6-theme', 'level-7-10-theme');
            // ‡∏ò‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà: L1-L2 (Blue), L3-L4 (Violet), L5-N (Orange)
            if (level >= 3 && level <= 4) {
                mainContainerEl.classList.add('level-4-6-theme');
            } else if (level >= 5) {
                mainContainerEl.classList.add('level-7-10-theme');
            } else {
                 mainContainerEl.classList.remove('level-4-6-theme', 'level-7-10-theme');
            }
        }
        
        function startGame(level) {
            currentLevel = level;
            // ‡πÉ‡∏ä‡πâ newLevels ‡πÅ‡∏ó‡∏ô allWords
            const levelData = newLevels.find(d => d.level === level); 
            if (!levelData) { console.error("Level data not found:", level); return; }
            
            applyLevelTheme(level);

            matchedPairs = 0;
            totalFlips = 0;
            gameLocked = false;
            timeElapsed = 0;
            updateStats();
            messageAreaEl.textContent = "";
            messageAreaEl.style.fontSize = '1rem';
            endGameControlsEl.style.display = 'none';
            nextLevelBtn.style.display = 'block'; 
            window.speechSynthesis.cancel(); 

            levelInfoEl.textContent = `Level ${level}: ${levelData.gridSize}`;
            
            setupCards(levelData);
            showScreen('game-screen');
            startTimer();
        }

        function handleCardClick(event) {
            if (gameLocked || isSpeaking) return; 
            
            const cardEl = event.currentTarget;
            const cardIndex = parseInt(cardEl.getAttribute('data-index'));
            const cardData = cards[cardIndex];

            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
            
            cardEl.classList.add('flipped');
            flippedCards.push({ cardEl, cardData });
            
            if (flippedCards.length === 2) {
                gameLocked = true;
                totalFlips++;
                updateStats();
                checkForMatch();
            }
        }

        function checkForMatch() {
            const card1 = flippedCards[0].cardData;
            const card2 = flippedCards[1].cardData;
            const card1El = flippedCards[0].cardEl;
            const card2El = flippedCards[1].cardEl;
            
            const isMatch = (card1.matchId === card2.matchId) && (card1.type !== card2.type);
            const wordToSpeak = card1.type === 'word' ? card1.content : card2.content;
            // ‡πÉ‡∏ä‡πâ newLevels ‡πÅ‡∏ó‡∏ô allWords
            const currentLevelData = newLevels.find(d => d.level === currentLevel); 


            if (isMatch) {
                // SUCCESS
                score += 1; 
                matchedPairs++;
                
                playSound('success');
                
                card1El.classList.add('matched-correct');
                card2El.classList.add('matched-correct');
                
                messageAreaEl.textContent = `üéâ MATCH! (${wordToSpeak}) ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà ${matchedPairs}/${currentLevelData.words.length}`;
                messageAreaEl.style.color = 'var(--color-correct)';
                
                speakWord(wordToSpeak, () => {
                    setTimeout(() => {
                        card1El.classList.add('matched');
                        card2El.classList.add('matched');
                        
                        card1El.classList.remove('matched-correct');
                        card2El.classList.remove('matched-correct');
                        
                        gameLocked = false;
                        flippedCards = [];
                        checkWinCondition();
                    }, 1000); 
                });
                
            } else {
                // ERROR
                playSound('error'); 
                
                const inner1 = card1El.querySelector('.card-inner');
                const inner2 = card2El.querySelector('.card-inner');
                
                inner1.classList.add('shake-error');
                inner2.classList.add('shake-error');
                
                messageAreaEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                messageAreaEl.style.color = 'var(--color-wrong)';
                
                setTimeout(() => {
                    card1El.classList.remove('flipped');
                    card2El.classList.remove('flipped');
                    
                    inner1.classList.remove('shake-error');
                    inner2.classList.remove('shake-error');
                    
                    gameLocked = false;
                    flippedCards = [];
                }, 1200);
            }
        }

        function checkWinCondition() {
            // ‡πÉ‡∏ä‡πâ newLevels ‡πÅ‡∏ó‡∏ô allWords
            const currentLevelData = newLevels.find(d => d.level === currentLevel);
            const totalPairs = currentLevelData ? currentLevelData.words.length : 0;
            
            if (matchedPairs === totalPairs) {
                stopTimer();
                window.speechSynthesis.cancel();
                messageAreaEl.textContent = `üèÜ ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!`;
                messageAreaEl.style.fontSize = '1.2rem';
                messageAreaEl.style.color = 'var(--color-primary)';
                
                endGameControlsEl.style.display = 'flex';
                
                if (currentLevel === newLevels.length) {
                    nextLevelBtn.style.display = 'none';
                    messageAreaEl.textContent += ` (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Level ‡πÅ‡∏•‡πâ‡∏ß!)`;
                } else {
                    nextLevelBtn.style.display = 'block';
                }
            }
        }

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeech();
            createLevelButtons(); 

            // Bind Control Buttons
            document.getElementById('main-menu-btn-play').addEventListener('click', goToLevelSelect);
            document.getElementById('play-again-btn').addEventListener('click', () => {
                startGame(currentLevel); 
            });
            document.getElementById('next-level-btn').addEventListener('click', () => {
                if (currentLevel < newLevels.length) {
                    startGame(currentLevel + 1);
                } else {
                    goToLevelSelect();
                }
            });

            // Bind level selection click handler
            levelGridSelectEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.closest('#level-grid-select')) {
                    const levelId = parseInt(e.target.getAttribute('data-level'));
                    if (!isNaN(levelId)) {
                        startGame(levelId);
                    }
                }
            });

            showScreen('level-select-screen');
        });
    </script>
</body>
</html>
