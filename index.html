<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Icons Match üß†</title> 
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL THEME SETUP --- */
        :root {
            /* Fallback Colors (L1-L3: Blue Theme) */
            --color-primary: #1976D2; 
            --color-secondary: #00BCD4; 
            --color-card-front: #BBDEFB; 
            --color-card-back: #1976D2; 
            --color-text-light: #FFFFFF;
            
            --color-correct: #8BC34A; 
            --color-wrong: #F44336; 
            --color-bg: #E3F2FD; 
            --color-text-dark: #263238;
        }
        
        /* Level 4-6 Theme: Pink/Violet */
        .level-4-6-theme {
            --color-primary: #8E24AA; 
            --color-secondary: #FF4081; 
            --color-card-front: #F8BBD0; 
            --color-card-back: #8E24AA; 
            --color-bg: #FCE4EC; 
        }
        
        /* Level 7-10 Theme: Yellow/Orange */
        .level-7-10-theme {
            --color-primary: #FF9800; 
            --color-secondary: #FFEB3B; 
            --color-card-front: #FFE0B2; 
            --color-card-back: #FF9800; 
            --color-bg: #FFF3E0; 
        }

        /* --- CONTAINER & BASE STYLES --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            overflow-x: hidden; /* Prevent horizontal scroll from shake */
        }

        .container {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
            background-color: #FFFFFF;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 0;
            transition: background-color 0.5s;
        }

        /* --- SHAKE EFFECT (for wrong match) --- */
        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ú‡∏¥‡∏î */
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        .container.shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        header {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            padding: 1rem 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.5s;
        }
        header h1 { font-size: 1.8rem; margin: 0; } 
        
        .screen {
            padding: 1rem;
            display: none; 
            flex-grow: 1;
            flex-direction: column;
            justify-content: space-between;
        }
        .screen.active { display: flex; }

        .status-bar {
             display: flex;
             justify-content: space-around;
             padding: 10px 0;
             font-weight: bold;
             font-size: 1rem;
             color: var(--color-primary);
             transition: color 0.5s;
        }
        
        #level-grid-select {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 15px;
             padding: 1rem 0;
        }

        /* --- Card Grid and Card Styles --- */
        #game-grid {
            width: 95%;
            margin: 1rem auto;
            display: grid;
            gap: 10px;
        }

        .card {
            height: 80px; 
            perspective: 1000px; 
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
        }

        /* Card Flip Animation */
        .card.flipped .card-inner { transform: rotateY(180deg); }

        .card-inner {
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        /* --- JUMP EFFECT (for correct match) --- */
        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°/‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ñ‡∏π‡∏Å */
        .card.matched-correct {
            animation: jump 0.8s ease-out;
        }
        @keyframes jump {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
            50% { transform: scale(1.08) translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-weight: 700;
            padding: 5px;
            box-sizing: border-box;
            text-align: center;
        }

        .card-back {
            background-color: var(--color-card-back);
            color: var(--color-text-light);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,.2) 0px, rgba(255,255,255,.2) 1px, transparent 1px, transparent 10px);
            border: 3px solid var(--color-primary);
            font-size: 1.5rem;
        }

        .card-front {
            background-color: var(--color-card-front);
            color: var(--color-text-dark);
            transform: rotateY(180deg);
            border: 3px solid var(--color-secondary);
            font-size: 1.1rem; 
        }
        
        .card-content-icon {
            font-size: 2.5rem; 
        }
        
        .card.matched .card-inner {
            box-shadow: 0 0 15px var(--color-correct);
            opacity: 0.5;
            cursor: default;
        }
        .card.matched .card-front {
             border-color: var(--color-correct);
        }

        /* Control Button Styles */
        .control-btn {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            padding: 1rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--color-primary); 
            transition: all 0.1s, background-color 0.5s, box-shadow 0.5s;
            width: 100%; 
        }
        .control-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--color-primary);
        }
        #game-controls { margin-top: 1rem; width: 100%; }
        #play-controls { display: flex; gap: 10px; width: 100%; }
        #play-controls .control-btn { width: 50%; }
        #end-game-controls { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .success-btn {
            background-color: var(--color-correct);
            box-shadow: 0 4px 0 #558B2F;
        }
        .secondary-btn {
            background-color: #607D8B; 
            box-shadow: 0 4px 0 #455A64;
        }

        #message-area {
            min-height: 2rem;
            font-weight: bold;
            margin-top: 1rem;
            color: var(--color-secondary);
            transition: color 0.5s;
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <header id="game-header">
            <h1>Word Icons Match üß†</h1>
        </header>

        <div id="level-select-screen" class="screen active">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (10 Levels)</h2>
            <p>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
            <div id="level-grid-select">
                </div>
        </div>
        
        <div id="game-screen" class="screen">
            <div class="status-bar">
                <span id="level-info">Level 1: 3x4</span>
                <span id="flips">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: 0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                <span id="timer">‡πÄ‡∏ß‡∏•‡∏≤: 0.00 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
            </div>
            
            <div id="game-grid">
                </div>
            
            <div id="message-area"></div>
            
            <div id="game-controls">
                <div id="play-controls" style="display: flex;">
                    <button id="main-menu-btn-play" class="control-btn secondary-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å üè†</button>
                </div>

                <div id="end-game-controls" style="display: none; margin-top: 10px;">
                    <button id="play-again-btn" class="control-btn success-btn">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ) üîÑ</button>
                    <button id="next-level-btn" class="control-btn">Level ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA: 10 Levels using Basic Emojis (unchanged) ---
        const allWords = [
            // Level 1: 3x4 Grid (6 Pairs, 12 Cards) - Basic Nouns
            { level: 1, gridSize: '3x4', words: [
                { word: "CAT", icon: "üê±", matchId: 1 }, { word: "DOG", icon: "üê∂", matchId: 2 }, { word: "CAR", icon: "üöó", matchId: 3 },
                { word: "SUN", icon: "‚òÄÔ∏è", matchId: 4 }, { word: "TREE", icon: "üå≥", matchId: 5 }, { word: "BALL", icon: "‚öΩ", matchId: 6 }
            ]},
            // Level 2: 4x4 Grid (8 Pairs, 16 Cards) - Colors/Food
            { level: 2, gridSize: '4x4', words: [
                { word: "APPLE", icon: "üçé", matchId: 7 }, { word: "BANANA", icon: "üçå", matchId: 8 }, { word: "RED", icon: "üî¥", matchId: 9 },
                { word: "BLUE", icon: "üîµ", matchId: 10 }, { word: "HOUSE", icon: "üè†", matchId: 11 }, { word: "CLOCK", icon: "‚è∞", matchId: 12 },
                { word: "BOOK", icon: "üìö", matchId: 13 }, { word: "STAR", icon: "‚≠ê", matchId: 14 }
            ]},
            // Level 3: 4x4 Grid (8 Pairs, 16 Cards) - Actions/Verbs (Icon Representation)
            { level: 3, gridSize: '4x4', words: [
                { word: "WALK", icon: "üö∂", matchId: 15 }, { word: "RUN", icon: "üèÉ", matchId: 16 }, { word: "SIT", icon: "ü™ë", matchId: 17 },
                { word: "SLEEP", icon: "üò¥", matchId: 18 }, { word: "DRINK", icon: "ü•õ", matchId: 19 }, { word: "EAT", icon: "üçΩÔ∏è", matchId: 20 },
                { word: "GIFT", icon: "üéÅ", matchId: 21 }, { word: "LOVE", icon: "‚ù§Ô∏è", matchId: 22 }
            ]},
            // Level 4: 4x5 Grid (10 Pairs, 20 Cards) - Abstract/Feelings
            { level: 4, gridSize: '4x5', words: [
                { word: "HAPPY", icon: "üòä", matchId: 23 }, { word: "SAD", icon: "üòî", matchId: 24 }, { word: "SHOCK", icon: "üò≤", matchId: 25 },
                { word: "IDEA", icon: "üí°", matchId: 26 }, { word: "MONEY", icon: "üí∞", matchId: 27 }, { word: "TICKET", icon: "üé´", matchId: 28 },
                { word: "PEN", icon: "üñäÔ∏è", matchId: 29 }, { word: "KEY", icon: "üîë", matchId: 30 }, { word: "CUP", icon: "‚òï", matchId: 31 }, { word: "FLAG", icon: "üö©", matchId: 32 }
            ]},
            // Level 5: 4x5 Grid (10 Pairs, 20 Cards) - Nature/Weather
            { level: 5, gridSize: '4x5', words: [
                { word: "WATER", icon: "üíß", matchId: 33 }, { word: "FIRE", icon: "üî•", matchId: 34 }, { word: "CLOUD", icon: "‚òÅÔ∏è", matchId: 35 },
                { word: "RAIN", icon: "üåßÔ∏è", matchId: 36 }, { word: "SNOW", icon: "‚ùÑÔ∏è", matchId: 37 }, { word: "FLOWER", icon: "üå∏", matchId: 38 },
                { word: "MOUNTAIN", icon: "‚õ∞Ô∏è", matchId: 39 }, { word: "MOON", icon: "üåï", matchId: 40 }, { word: "ROAD", icon: "üõ£Ô∏è", matchId: 41 }, { word: "BOAT", icon: "‚õµ", matchId: 42 }
            ]},
            // Level 6: 4x5 Grid (10 Pairs, 20 Cards) - Professions/People
            { level: 6, gridSize: '4x5', words: [
                { word: "DOCTOR", icon: "üßë‚Äç‚öïÔ∏è", matchId: 43 }, { word: "POLICE", icon: "üëÆ", matchId: 44 }, { word: "STUDENT", icon: "üßë‚Äçüéì", matchId: 45 },
                { word: "CHEF", icon: "üßë‚Äçüç≥", matchId: 46 }, { word: "KING", icon: "üëë", matchId: 47 }, { word: "FAMILY", icon: "üë™", matchId: 48 },
                { word: "BABY", icon: "üë∂", matchId: 49 }, { word: "HAND", icon: "‚úã", matchId: 50 }, { word: "EYE", icon: "üëÅÔ∏è", matchId: 51 }, { word: "EAR", icon: "üëÇ", matchId: 52 }
            ]},
            // Level 7: 5x4 Grid (10 Pairs, 20 Cards) - Mixed & Extended Basic
            { level: 7, gridSize: '5x4', words: [
                { word: "DESK", icon: "üñ•Ô∏è", matchId: 53 }, { word: "MOUSE", icon: "üñ±Ô∏è", matchId: 54 }, { word: "EMAIL", icon: "üìß", matchId: 55 },
                { word: "CALENDAR", icon: "üìÖ", matchId: 56 }, { word: "TRUCK", icon: "üöö", matchId: 57 }, { word: "BUS", icon: "üöå", matchId: 58 },
                { word: "WINE", icon: "üç∑", matchId: 59 }, { word: "BEER", icon: "üç∫", matchId: 60 }, { word: "PIZZA", icon: "üçï", matchId: 61 }, { word: "SHIRT", icon: "üëï", matchId: 62 }
            ]},
            // Level 8: 5x4 Grid (10 Pairs, 20 Cards) - Advanced Basic Objects
            { level: 8, gridSize: '5x4', words: [
                { word: "CAMERA", icon: "üì∑", matchId: 63 }, { word: "VIDEO", icon: "üìπ", matchId: 64 }, { word: "NOTE", icon: "üìù", matchId: 65 },
                { word: "CALCULATE", icon: "üßÆ", matchId: 66 }, { word: "GLOBE", icon: "üåç", matchId: 67 }, { word: "BAG", icon: "üëú", matchId: 68 },
                { word: "BIKE", icon: "üö≤", matchId: 69 }, { word: "TRAIN", icon: "üöÇ", matchId: 70 }, { word: "TENT", icon: "‚õ∫", matchId: 71 }, { word: "WIFI", icon: "üì∂", matchId: 72 }
            ]},
            // Level 9: 5x5 Grid (12 Pairs, 24 Cards) - Increased Difficulty
            { level: 9, gridSize: '5x5', words: [
                { word: "LOCK", icon: "üîí", matchId: 73 }, { word: "UNLOCK", icon: "üîì", matchId: 74 }, { word: "ARROW", icon: "‚¨ÜÔ∏è", matchId: 75 },
                { word: "DOWN", icon: "‚¨áÔ∏è", matchId: 76 }, { word: "PLUS", icon: "‚ûï", matchId: 77 }, { word: "MINUS", icon: "‚ûñ", matchId: 78 },
                { word: "WAVE", icon: "üåä", matchId: 79 }, { word: "HELICOPTER", icon: "üöÅ", matchId: 80 }, { word: "FIREWORKS", icon: "üéÜ", matchId: 81 },
                { word: "DIAMOND", icon: "üíé", matchId: 82 }, { word: "TROPHY", icon: "üèÜ", matchId: 83 }, { word: "GRADUATION", icon: "üéì", matchId: 84 }
            ]},
            // Level 10: 6x4 Grid (12 Pairs, 24 Cards) - Max Size
            { level: 10, gridSize: '6x4', words: [
                { word: "SMILE", icon: "üòÄ", matchId: 85 }, { word: "CRY", icon: "üò≠", matchId: 86 }, { word: "ANGRY", icon: "üò°", matchId: 87 },
                { word: "KISS", icon: "üíã", matchId: 88 }, { word: "SPEECH", icon: "üí¨", matchId: 89 }, { word: "CAMERA", icon: "üì∏", matchId: 90 },
                { word: "MIC", icon: "üé§", matchId: 91 }, { word: "HEADPHONE", icon: "üéß", matchId: 92 }, { word: "ZAP", icon: "‚ö°", matchId: 93 },
                { word: "HUG", icon: "ü´Ç", matchId: 94 }, { word: "DOOR", icon: "üö™", matchId: 95 }, { word: "BINOCULAR", icon: "üî≠", matchId: 96 }
            ]}
        ];

        // --- GAME STATE & ELEMENTS (Unchanged) ---
        let currentLevel = null;
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalFlips = 0;
        let score = 0;
        let gameLocked = false; 
        let timerInterval = null;
        let timeElapsed = 0;
        let startTime = 0;
        let isSpeaking = false; 

        const mainContainerEl = document.getElementById('main-container');
        const levelSelectScreen = document.getElementById('level-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameGridEl = document.getElementById('game-grid');
        const levelInfoEl = document.getElementById('level-info');
        const flipsEl = document.getElementById('flips');
        const timerEl = document.getElementById('timer');
        const messageAreaEl = document.getElementById('message-area');
        const endGameControlsEl = document.getElementById('end-game-controls');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const levelGridSelectEl = document.getElementById('level-grid-select');
        
        // --- SPEECH & SOUND FUNCTIONS ---
        
        let utterance = null;
        function setupSpeech() {
            if ('speechSynthesis' in window) {
                utterance = new SpeechSynthesisUtterance();
                utterance.volume = 1; 
                utterance.rate = 0.8; // Slightly slower speed for learning
                utterance.pitch = 1;
                utterance.lang = 'en-US';
                // Trigger voice loading
                window.speechSynthesis.getVoices(); 
            }
        }

        /**
         * @description ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
         * @param {string} text ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô
         * @param {function} callback ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö
         */
        function speakWord(text, callback = null) {
            if (utterance) {
                window.speechSynthesis.cancel();
                utterance.text = text;
                
                const voices = window.speechSynthesis.getVoices();
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
                utterance.voice = voices.find(v => v.lang.startsWith('en-US') || v.lang.startsWith('en-GB') || v.lang.startsWith('en-')); 

                isSpeaking = true;
                utterance.onend = () => {
                    isSpeaking = false;
                    if (callback) callback();
                };
                
                try {
                    window.speechSynthesis.speak(utterance); 
                } catch(e) {
                    console.error("Speech synthesis failed to start:", e);
                    isSpeaking = false;
                    if (callback) callback();
                }
            } else {
                if (callback) callback();
            }
        }

        /**
         * @description ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÜ (Pling/Buzz)
         * @param {string} type 'success' (‡∏õ‡∏¥‡πä‡∏á) ‡∏´‡∏£‡∏∑‡∏≠ 'error' (‡∏≠‡πä‡∏≠‡∏î/‡∏™‡∏±‡πà‡∏ô)
         */
        function playSound(type) {
            if (typeof AudioContext === 'undefined') return;

            const context = new AudioContext();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            if (type === 'success') {
                oscillator.type = 'square'; 
                oscillator.frequency.setValueAtTime(880, context.currentTime); 
                gainNode.gain.setValueAtTime(0.5, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.3);
            } else if (type === 'error') {
                oscillator.type = 'sawtooth'; 
                oscillator.frequency.setValueAtTime(150, context.currentTime); 
                gainNode.gain.setValueAtTime(0.4, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.4);
            }

            oscillator.start();
            oscillator.stop(context.currentTime + 0.4);
        }

        // --- HELPER FUNCTIONS (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á) ---

        /**
         * @description ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå (Fisher-Yates Shuffle)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * @description ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏≤‡∏° ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
         */
        function showScreen(id) {
            window.speechSynthesis.cancel();
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        /**
         * @description ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
         */
        function updateStats() {
            flipsEl.textContent = `‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà: ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
            timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        
        /**
         * @description ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
         */
        function startTimer() {
             startTime = performance.now();
             clearInterval(timerInterval);
             timerInterval = setInterval(() => {
                 timeElapsed = (performance.now() - startTime) / 1000;
                 timerEl.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
             }, 100);
        }

        /**
         * @description ‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
         */
        function stopTimer() {
             clearInterval(timerInterval);
        }

        /**
         * @description ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Level Selection
         */
        function createLevelButtons() {
            levelGridSelectEl.innerHTML = '';
            allWords.forEach(data => {
                const btn = document.createElement('button');
                btn.className = 'control-btn';
                btn.textContent = `Level ${data.level} (${data.gridSize})`;
                btn.setAttribute('data-level', data.level);
                
                // Set theme for buttons
                if (data.level >= 4 && data.level <= 6) {
                    btn.style.backgroundColor = 'var(--color-primary, #8E24AA)'; 
                } else if (data.level >= 7 && data.level <= 10) {
                    btn.style.backgroundColor = 'var(--color-primary, #FF9800)'; 
                } else {
                    btn.style.backgroundColor = 'var(--color-primary, #1976D2)'; 
                }

                btn.addEventListener('click', () => {
                    startGame(data.level);
                });
                levelGridSelectEl.appendChild(btn);
            });
        }
        
        /**
         * @description ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
         */
        function setupCards(levelData) {
            const wordPairs = levelData.words;
            cards = [];

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î Word ‡πÅ‡∏•‡∏∞ Icon
            wordPairs.forEach(pair => {
                cards.push({ content: pair.word, type: 'word', matchId: pair.matchId });
                cards.push({ content: pair.icon, type: 'icon', matchId: pair.matchId });
            });

            // 2. ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
            cards = shuffleArray(cards);

            // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Grid ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á UI
            gameGridEl.innerHTML = '';
            const [cols, rows] = levelData.gridSize.split('x').map(Number);
            
            // Adjust CSS grid layout
            gameGridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameGridEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            cards.forEach((cardData, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.setAttribute('data-index', index);
                cardEl.setAttribute('data-match-id', cardData.matchId);
                cardEl.addEventListener('click', handleCardClick);

                const cardInner = document.createElement('div');
                cardInner.className = 'card-inner';

                const cardFront = document.createElement('div');
                cardFront.className = 'card-front';
                
                // Display content appropriately
                if (cardData.type === 'word') {
                     cardFront.textContent = cardData.content;
                } else {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'card-content-icon';
                    iconSpan.textContent = cardData.content;
                    cardFront.appendChild(iconSpan);
                }

                const cardBack = document.createElement('div');
                cardBack.className = 'card-back';
                cardBack.textContent = '?';

                cardInner.appendChild(cardBack);
                cardInner.appendChild(cardFront);
                cardEl.appendChild(cardInner);
                gameGridEl.appendChild(cardEl);
            });
        }
        
        /**
         * @description ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Level
         */
        function goToLevelSelect() {
            showScreen('level-select-screen');
        }


        // --- GAME FLOW (Adjusted for effects/TTS) ---
        
        function applyLevelTheme(level) {
            mainContainerEl.classList.remove('level-4-6-theme', 'level-7-10-theme');
            if (level >= 4 && level <= 6) {
                mainContainerEl.classList.add('level-4-6-theme');
            } else if (level >= 7 && level <= 10) {
                mainContainerEl.classList.add('level-7-10-theme');
            } else {
                 // Ensures default theme is applied for 1-3
                 mainContainerEl.classList.remove('level-4-6-theme', 'level-7-10-theme');
            }
        }
        
        function startGame(level) {
            currentLevel = level;
            const levelData = allWords.find(d => d.level === level);
            if (!levelData) { console.error("Level data not found:", level); return; }
            
            applyLevelTheme(level);

            matchedPairs = 0;
            totalFlips = 0;
            gameLocked = false;
            timeElapsed = 0;
            updateStats();
            messageAreaEl.textContent = "";
            messageAreaEl.style.fontSize = '1rem';
            endGameControlsEl.style.display = 'none';
            nextLevelBtn.style.display = 'block'; 
            window.speechSynthesis.cancel(); 

            levelInfoEl.textContent = `Level ${level}: ${levelData.gridSize}`;
            
            setupCards(levelData);
            showScreen('game-screen');
            startTimer();
        }

        function handleCardClick(event) {
            // Check if game is locked or if speech is active 
            if (gameLocked || isSpeaking) return; 
            
            const cardEl = event.currentTarget;
            const cardIndex = parseInt(cardEl.getAttribute('data-index'));
            const cardData = cards[cardIndex];

            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
            
            cardEl.classList.add('flipped');
            flippedCards.push({ cardEl, cardData });
            
            if (flippedCards.length === 2) {
                gameLocked = true;
                totalFlips++;
                updateStats();
                checkForMatch();
            }
        }

        function checkForMatch() {
            const card1 = flippedCards[0].cardData;
            const card2 = flippedCards[1].cardData;
            const card1El = flippedCards[0].cardEl;
            const card2El = flippedCards[1].cardEl;
            
            const isMatch = (card1.matchId === card2.matchId) && (card1.type !== card2.type);
            // ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const wordToSpeak = card1.type === 'word' ? card1.content : card2.content;

            if (isMatch) {
                // --- 1. SUCCESS EFFECT & TTS ---
                score += 1; 
                matchedPairs++;
                
                playSound('success'); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏õ‡∏¥‡πä‡∏á"
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå "‡∏ã‡∏π‡∏°/‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î"
                card1El.classList.add('matched-correct');
                card2El.classList.add('matched-correct');
                
                messageAreaEl.textContent = `üéâ MATCH! (${wordToSpeak}) ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà ${matchedPairs}/${allWords.find(d => d.level === currentLevel).words.length}`;
                messageAreaEl.style.color = 'var(--color-correct)';
                
                // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
                speakWord(wordToSpeak, () => {
                    // 3. ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏π‡∏î) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
                    setTimeout(() => {
                        // 4. Mark as matched and unlock
                        card1El.classList.add('matched');
                        card2El.classList.add('matched');
                        
                        card1El.classList.remove('matched-correct');
                        card2El.classList.remove('matched-correct');
                        
                        gameLocked = false;
                        flippedCards = [];
                        checkWinCondition();
                    }, 1000); // ‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡πÑ‡∏û‡πà‡∏Ñ‡∏≥‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏ß‡πâ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                });
                
            } else {
                // --- 5. ERROR EFFECT ---
                playSound('error'); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á "‡∏≠‡πä‡∏≠‡∏î"
                mainContainerEl.classList.add('shake'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå "‡∏™‡∏±‡πà‡∏ô"
                
                messageAreaEl.textContent = `‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                messageAreaEl.style.color = 'var(--color-wrong)';
                
                // Flip cards back after a delay
                setTimeout(() => {
                    card1El.classList.remove('flipped');
                    card2El.classList.remove('flipped');
                    mainContainerEl.classList.remove('shake'); // ‡∏•‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏™‡∏±‡πà‡∏ô
                    gameLocked = false;
                    flippedCards = [];
                }, 1200);
            }
        }

        function checkWinCondition() {
            const currentLevelData = allWords.find(d => d.level === currentLevel);
            const totalPairs = currentLevelData ? currentLevelData.words.length : 0;
            
            if (matchedPairs === totalPairs) {
                stopTimer();
                window.speechSynthesis.cancel();
                messageAreaEl.textContent = `üèÜ ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${timeElapsed.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà ${totalFlips} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!`;
                messageAreaEl.style.fontSize = '1.2rem';
                messageAreaEl.style.color = 'var(--color-primary)';
                
                endGameControlsEl.style.display = 'flex';
                
                if (currentLevel === allWords.length) {
                    nextLevelBtn.style.display = 'none';
                    messageAreaEl.textContent += ` (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å Level ‡πÅ‡∏•‡πâ‡∏ß!)`;
                } else {
                    nextLevelBtn.style.display = 'block';
                }
            }
        }

        // --- INITIAL SETUP (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á) ---
        document.addEventListener('DOMContentLoaded', () => {
            setupSpeech();
            createLevelButtons(); // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°**

            // Bind Control Buttons
            document.getElementById('main-menu-btn-play').addEventListener('click', goToLevelSelect);
            document.getElementById('play-again-btn').addEventListener('click', () => {
                startGame(currentLevel); 
            });
            document.getElementById('next-level-btn').addEventListener('click', () => {
                if (currentLevel < allWords.length) {
                    startGame(currentLevel + 1);
                } else {
                    goToLevelSelect();
                }
            });

            // Bind level selection buttons (re-using createLevelButtons logic)
            levelGridSelectEl.addEventListener('click', (e) => {
                // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö class/tag name ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô**
                if (e.target.tagName === 'BUTTON' && e.target.closest('#level-grid-select')) {
                    const levelId = parseInt(e.target.getAttribute('data-level'));
                    if (!isNaN(levelId)) {
                        startGame(levelId);
                    }
                }
            });

            showScreen('level-select-screen');
        });
    </script>
</body>
</html>
